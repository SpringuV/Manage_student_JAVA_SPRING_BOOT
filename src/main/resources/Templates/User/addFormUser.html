<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add User</title>
    <link href="/CSS/bootstrap-5.3.3-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/CSS/main.css" rel="stylesheet" type="text/css">
    <script src="/JavaScript/function.js"></script>
    <script src="/CSS/bootstrap-5.3.3-dist/js/bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
<div class="container">
    <div class="row">
        <div class="col-lg-6">
            <form th:action="@{/m-user/add-process}" th:object="${user}" method="post">
                <div th:if="${Error}" class="alert alert-danger">
                    <span th:text="${Error}"></span>
                </div>
                <div th:if="${success}" class="alert alert-success">
                    <span th:text="${success}"></span>
                </div>
                <div align="center">
                    <h1>Register User</h1>
                </div>
                <div class="form-outline mb-1">
                    <label for="position_select" class="form-label">Current Occupation: </label>
                    <select th:field="*{position}" id="position_select" name="position" required>
                        <option th:value="User" selected>User</option>
                        <option th:value="Parent">Parent</option>
                        <option th:value="Student">Student</option>
                        <option th:value="Teacher">Teacher</option>
                    </select>
                </div>
                <!--       The Fields input will be displayed after the Position selected-->
                <!--START common fields-->
                <div id="common-fields">
                    <div class="form-floating mb-1">
                        <input type="text" th:field="*{username}" name="username" placeholder="Input Username (*)"
                               id="usernameid"
                               class="form-control"/>
                        <label class="form-label" for="usernameid">User name: </label>
                        <div th:if="${#fields.hasErrors('username')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('username')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="password" th:field="*{password}" name="password" placeholder="Input Password (*)"
                               id="password" class="form-control"/>
                        <label class="form-label" for="password">Password</label>
                        <div th:if="${#fields.hasErrors('password')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('password')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" th:field="*{firstName}" name="firstname" placeholder="Input First Name (*)"
                               id="firstname" class="form-control"/>
                        <label class="form-label" for="firstname">First Name</label>
                        <div th:if="${#fields.hasErrors('firstName')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('firstName')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" th:field="*{lastName}" name="lastname" placeholder="Input Last Name (*)"
                               id="lastname" class="form-control"/>
                        <label class="form-label" for="lastname">Last Name: </label>
                        <div th:if="${#fields.hasErrors('lastName')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('lastName')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" th:field="*{address}" name="address" placeholder="Input Address (*)"
                               id="address"
                               class="form-control"/>
                        <label class="form-label" for="address">Address: </label>
                        <div th:if="${#fields.hasErrors('address')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('address')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" th:field="*{identity}" name="identity" placeholder="Input Identity (*)"
                               id="identity"
                               class="form-control"/>
                        <label class="form-label" for="identity">Identity: </label>
                        <div th:if="${#fields.hasErrors('identity')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('identity')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="email" th:field="*{email}" name="email" placeholder="Input Email (*)" id="email"
                               class="form-control"/>
                        <label class="form-label" for="email">Email: </label>
                        <div th:if="${#fields.hasErrors('email')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('email')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!--END common fields-->

                <!--START Addition Student field-->
                <div id="student-fields">
                    <div class="form-outline mb-1">
                        <label for="student_school_select" class="form-label">Study at school: </label>
                        <select th:field="*{school}" id="student_school_select" required>
                            <option value="">--Select School--</option>
                            <option th:each="school : ${schoolList}" th:value="${school.id}"
                                    th:text="${school.name}"></option>
                        </select>
                        <div th:if="${#fields.hasErrors('school')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('school')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <!-- Because relation between the entity class and the entity teacher is one to many, a class has many teacher, and opposite
                    so that the class must to selected before the teacher
                    -->
                    <div class="form-outline mb-1">
                        <label class="form-label" for="student_class_select">Select Class: </label>
                        <select th:field="*{classes}" id="student_class_select">
                            <option value="0">--Select Class--</option>
                        </select>
                        <div th:if="${#fields.hasErrors('classes')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('classes')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-outline mb-1">
                        <label class="form-label" for="student_teacher_select">Select Teacher: </label>
                        <select th:field="*{teacher}" id="student_teacher_select">
                            <option value="0">--Select Teacher--</option>
                        </select>
                        <div th:if="${#fields.hasErrors('teacher')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('teacher')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!--END Addition Student field-->

                <!--START Addition TEACHER field-->
                <div id="teacher-fields">
                    <div class="form-floating mb-1">
                        <input type="tel" th:field="*{phoneNumber}" placeholder="Input phone user"
                               name="userPhone" id="teacher_phone" class="form-control">
                        <label class="form-label" for="teacher_phone">User Phone: </label>
                        <div th:if="${#fields.hasErrors('phoneNumber')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('phoneNumber')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-outline mb-1">
                        <label for="teacher_school_select" class="form-label">Work at school: </label>
                        <select id="teacher_school_select" th:field="*{school}" required>
                            <option value="">--Select School--</option>
                            <option th:each="school : ${schoolList}" th:value="${school.id}"
                                    th:text="${school.name}"></option>
                        </select>
                        <div th:if="${#fields.hasErrors('school')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('school')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-outline mb-1">
                        <label class="form-label" for="teacher_subject_select">Subject Select: </label>
                        <select name="subject" id="teacher_subject_select" th:field="*{subject}" required>
                            <option th:value="0">--Select Subject--</option>
                        </select>

                        <div th:if="${#fields.hasErrors('subject')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('subject')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-outline mb-1">
                        <label class="form-label" for="teacher_class_select">Class Select: </label>
                        <select name="classes" id="teacher_class_select" th:field="*{classes}" required>
                            <option th:value="0">--Select Class--</option>
                        </select>

                        <div th:if="${#fields.hasErrors('classes')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('classes')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!--END Addition Teacher field-->

                <!--START Addition Parent field-->
                <div id="parent-fields">
                    <div class="form-floating mb-1">
                        <input type="tel" th:field="*{phoneNumber}" placeholder="Input phone user"
                               name="userPhone" id="parent_phone" class="form-control">
                        <label class="form-label" for="parent_phone">User Phone: </label>
                        <div th:if="${#fields.hasErrors('phoneNumber')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('phoneNumber')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-outline mb-1">
                        <label for="parent_school_select" class="form-label">School Select: </label>
                        <select id="parent_school_select" th:field="*{school}" required>
                            <option value="0">--Select School--</option>
                            <option th:each="school : ${schoolList}" th:value="${school.id}"
                                    th:text="${school.name} +' ('+${school.level}+')'"></option>
                        </select>
                        <div th:if="${#fields.hasErrors('school')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('school')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-outline mb-1">
                        <label for="parent_class_select" class="form-label">Class: </label>
                        <select id="parent_class_select" required>
                            <option value="0">--Select Class--</option>
                        </select>
                    </div>

                    <div class="form-outline mb-1">
                        <label for="parent_student_select" class="form-label">Parent of Student: </label>
                        <select id="parent_student_select" th:field="*{student}" required>
                            <option value="0">--Select Student--</option>
                        </select>
                        <div th:if="${#fields.hasErrors('student')}">
                            <ul>
                                <li th:each="error: ${#fields.hasErrors('student')}" th:text="${error}"></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!--END Addition Parent field-->
                <button class="btn btn-primary py-2" type="submit">Register</button>
                <a class="btn btn-primary py-2" th:href="@{/showLoginPage}">Return Login</a>
                <a sec:authorize="hasAnyRole('ADMIN', 'MANAGER')" class="btn btn-primary py-2" th:href="@{/m-user/showManageUser}">UserList Manage</a>
            </form>
        </div>
    </div>
    <p class="mt-5 mb-3 text-body-secondary">© 2017–2024</p>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        // START POSITION
        const positionSelect = document.getElementById('position_select');

        function hideAllFields(){
            // Hide all additional fields
            document.getElementById('parent-fields').style.display = "none";
            document.getElementById('teacher-fields').style.display = "none";
            document.getElementById('student-fields').style.display = "none";
        }

        // Hide all fields initially
        hideAllFields();

        // Display the corresponding fields based on the position
        positionSelect.addEventListener('change', function(){
            const position = positionSelect.value;
            if(position === "Parent"){
                document.getElementById('parent-fields').style.display = "block";
                document.getElementById('teacher-fields').style.display = "none";
                document.getElementById('student-fields').style.display = "none";
            } else if (position === "Teacher"){
                document.getElementById('teacher-fields').style.display = "block";
                document.getElementById('parent-fields').style.display = "none";
                document.getElementById('student-fields').style.display = "none";
            } else if (position === "Student"){
                document.getElementById('parent-fields').style.display = "none";
                document.getElementById('teacher-fields').style.display = "none";
                document.getElementById('student-fields').style.display = "block";
            } else {
                hideAllFields();
            }
        });
        // END POSITION

        // START SELECT
            // Student
                const studentSchoolSelect = document.getElementById('student_school_select');
                const studentClassSelect = document.getElementById('student_class_select');
                const studentTeacherSelect = document.getElementById('student_teacher_select');
            // Parent
                const teacherSchoolSelect = document.getElementById('teacher_school_select');
                const teacherSubjectSelect = document.getElementById('teacher_subject_select');
                const teacherClassSelect = document.getElementById('teacher_class_select');
            // Teacher
                const parentSchoolSelect = document.getElementById('parent_school_select');
                const parentClassSelect = document.getElementById('parent_class_select');
                const parentStudentSelect = document.getElementById('parent_student_select');

            function getClassBySchoolId(schoolId){
                if(schoolId && schoolId !== "0"){
                    // fetch class
                    fetch(`/m-class/getClassBySchoolId/${schoolId}`)
                    .then(response => response.json())
                    .then(classes =>{

                        const options = '<option value="0">--Select Class--</option>';
                        [studentClassSelect, parentClassSelect, teacherClassSelect].forEach(select => {
                            select.innerHTML = options;
                            classes.forEach(classItem =>{
                                const option = document.createElement('option');
                                option.value = classItem.id;
                                option.textContent = classItem.name;
                                select.appendChild(option);
                            });
                        });
                    })
                    .catch(error => console.error('Error fetching Class:', error));
                } else {
                    // if no school selected
                    studentClassSelect.innerHTML = '<option value="0">--Select Class--</option>';
                    parentClassSelect.innerHTML = '<option value="0">--Select Class--</option>';
                    teacherClassSelect.innerHTML = '<option value="0">--Select Class--</option>';
                }
            }

            function getStudentByClassAndSchool(schoolId, classId){
                if(schoolId && classId && schoolId !== "0" && classId !== "0"){
                    fetch(`/m-student/getStudentByClassAndSchool/${schoolId}/${classId}`)
                    .then(response => response.json())
                    .then(students => {
                        // clear previous student
                        parentStudentSelect.innerHTML='<option value="0">--Select Student--</option>';

                        students.forEach(studentItem =>{
                            const option = document.createElement('option');
                            option.value = studentItem.id;
                            option.textContent = `${studentItem.lastName} ${studentItem.firstName}`;
                            parentStudentSelect.appendChild(option);
                        });
                    })
                    .catch(error =>console.error('Error fetching Student:', error));
                } else {
                    // if no class or school selected
                    parentStudentSelect.innerHTML='<option value="0">--Select Student--</option>';
                }
            }

            function getSubjectBySchool(schoolId) {
                if (schoolId && schoolId !== "0") {
                    fetch(`/m-subject/getSubjectBySchool/${schoolId}`)
                        .then(response => response.json())
                        .then(subjects => {
                            // clear previous subject
                            teacherSubjectSelect.innerHTML = '<option value="0">--Select Subject--</option>';

                            // populate new subject
                            subjects.forEach(subjectItem => {
                                const option = document.createElement('option');
                                option.value = subjectItem.id;
                                option.textContent = subjectItem.nameSubject;
                                teacherSubjectSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching Subject:', error));
                } else {
                    // if no school selected
                    teacherSubjectSelect.innerHTML = '<option value="0">--Select Subject--</option>';
                }
            }

            function getTeacherBySchoolIdAndClassId(schoolId, classId){
                if(schoolId && classId && schoolId !== "0" && classId !== "0"){
                    // fetch teacher
                    fetch(`/m-teacher/getTeacherBySchoolAndClass/${schoolId}/${classId}`)
                    .then(response => response.json())
                    .then(teachers => {
                        // clear teacher previous
                        studentTeacherSelect.innerHTML= '<option>--Select Teacher--</option>';

                        // populate new teacher
                        teachers.forEach(teacherItem =>{
                            const option = document.createElement('option');
                            option.value = teacherItem.id;
                            option.textContent = `${teacherItem.lastName} ${teacherItem.firstName}`;
                            studentTeacherSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching Teacher:', error));
                } else {
                    // if no class or school selected
                    studentTeacherSelect.innerHTML= '<option>--Select Teacher--</option>';
                }
            }
            // START EVENT LISTENER
                // Start Student
                    // event listener for school selection change
                    studentSchoolSelect.addEventListener('change', function(){
                        const schoolId = studentSchoolSelect.value;
                        getClassBySchoolId(schoolId);
                    });

                    // event listener for the school and the class selection change
                    studentClassSelect.addEventListener('change', function(){
                        const schoolId = studentSchoolSelect.value;
                        const classId = studentClassSelect.value;
                        getTeacherBySchoolIdAndClassId(schoolId, classId);
                    });
                // End Student
                // Start Teacher
                    // event listener for school selection change
                    teacherSchoolSelect.addEventListener('change', function(){
                        const schoolId = teacherSchoolSelect.value;
                        getClassBySchoolId(schoolId);
                        getSubjectBySchool(schoolId);
                    });
                // End Teacher
                // Start Parent
                    // event listener for school selection change
                    parentSchoolSelect.addEventListener('change', function(){
                        const schoolId = parentSchoolSelect.value;
                        getClassBySchoolId(schoolId);
                    });
                    parentClassSelect.addEventListener('change', function(){
                        const schoolId = parentSchoolSelect.value;
                        const classId = parentClassSelect.value;
                        getStudentByClassAndSchool(schoolId, classId);
                    });
                // End Parent
            // END EVENT LISTENER
        // END SELECT
    });
</script>
<script src="/docs/5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>
</html>